/*amstramgramMediaPlayer.js--@version:1.0.0--@licence:MIT--@url:https://amp.onfaitdessites.fr/*/
function _classPrivateFieldGet(receiver,privateMap){return _classApplyDescriptorGet(receiver,_classExtractFieldDescriptor(receiver,privateMap,"get"))}function _classPrivateFieldSet(receiver,privateMap,value){return _classApplyDescriptorSet(receiver,_classExtractFieldDescriptor(receiver,privateMap,"set"),value),value}function _classExtractFieldDescriptor(receiver,privateMap,action){if(!privateMap.has(receiver))throw new TypeError("attempted to "+action+" private field on non-instance");return privateMap.get(receiver)}function _classStaticPrivateFieldSpecGet(receiver,classConstructor,descriptor){return _classCheckPrivateStaticAccess(receiver,classConstructor),_classCheckPrivateStaticFieldDescriptor(descriptor,"get"),_classApplyDescriptorGet(receiver,descriptor)}function _classApplyDescriptorGet(receiver,descriptor){return descriptor.get?descriptor.get.call(receiver):descriptor.value}function _classApplyDescriptorSet(receiver,descriptor,value){if(descriptor.set)descriptor.set.call(receiver,value);else{if(!descriptor.writable)throw new TypeError("attempted to set read only private field");descriptor.value=value}}function _classCheckPrivateStaticAccess(receiver,classConstructor){if(receiver!==classConstructor)throw new TypeError("Private static access of wrong provenance")}function _classCheckPrivateStaticFieldDescriptor(descriptor,action){if(void 0===descriptor)throw new TypeError("attempted to "+action+" private static field before its declaration")}class EventEmitter{constructor(){this.events={}}_getEventListByName(eventName){return void 0===this.events[eventName]&&(this.events[eventName]=new Set),this.events[eventName]}on(eventsNames,fn){const self=this;return eventsNames.split(" ").forEach((eventName=>{self._getEventListByName(eventName).has(fn)||self._getEventListByName(eventName).add(fn)})),this}emit(eventName,...args){return this._getEventListByName(eventName).forEach(function(fn){fn.apply(this,args)}.bind(this)),this}off(eventName,fn){this._getEventListByName(eventName).delete(fn)}}let throttle=(events,name,obj)=>{if(void 0===obj){if("undefined"==typeof window)return;obj=window}let running=!1,func=e=>{running||(running=!0,requestAnimationFrame((()=>{obj.dispatchEvent(new CustomEvent(name,{detail:e})),running=!1})))};events.split(" ").forEach((event=>obj.addEventListener(event,func)))};function isObject(o){return o&&o.constructor===Object}function mergeDeep(target,source){isObject(target)&&Object.isFrozen(target)||isObject(target)&&isObject(source)&&Object.keys(source).forEach((key=>{isObject(target[key])&&isObject(source[key])?mergeDeep(target[key],source[key]):!(key in target)||typeof target[key]!=typeof source[key]&&void 0!==target[key]||(target[key]=source[key])}))}function clone(o){const copy={};return Object.keys(o).forEach((key=>{copy[key]=isObject(o[key])?clone(o[key]):o[key]})),copy}function checkString(s){return"string"==typeof s&&s.length>0}function buildSrc(params,media){if(checkString(params))return[{src:params}];if(isObject(params)&&2==Object.keys(params).length&&params.src&&params.type&&checkString(params.src)&&checkString(params.type))return!!media.canPlayType(params.type)&&[params];if(Array.isArray(params)){if(1==params.length){const o=params[0];if(o.src&&checkString(o.src))return o.type?!!media.canPlayType(o.type)&&params:[{src:o.src}]}return params.filter((o=>o.src&&checkString(o.src)&&o.quality&&checkString(o.quality))).filter((o=>!o.type||o.type&&media.canPlayType(o.type)))}return!1}function buildSrcParams(params,media,init=!0){let result=buildSrc(params,media);if(result)return{src:result};if(isObject(params)&&(result=buildSrc(params.src,media),result))return params.src=result,params;if(!init){let sources=[];const sourcesTag=Array.from(media.querySelectorAll("source"));if(sourcesTag.length>0?sourcesTag.forEach((s=>{let o={};o.src=s.src,s.getAttribute("data-quality")&&(o.quality=s.getAttribute("data-quality")),s.getAttribute("type")&&(o.type=s.getAttribute("type")),Boolean(s.getAttribute("data-default"))&&(o.default=Boolean(s.getAttribute("data-default"))),sources.push(o),s.remove()})):media.src&&""!=media.src&&sources.push({src:media.src,type:media.getAttribute("type")}),result=buildSrc(sources,media),result)return params.src=result,params}return params.src=[],params}function secondsToTimeCode(t,long=!1){if(isNaN(t))return long?"00:00:00":"00:00";t=Math.round(t);let h=Math.floor(t/3600),m=Math.floor((t-3600*h)/60),s=Math.round(t%60);return h=h>9?h+":":h>0?"0"+h+":":long?"00:":"",m=m>9?m:"0"+m,s=s>9?s:"0"+s,h+m+":"+s}const instanceOptions$1={appLabel:"Audio Player",alwaysShowHours:!1,compactMaxWidth:600,errorMessage:"Oups ! Media can't be found !!!",hideControlsDelay:5e3,miniMaxWidth:500,timeSliderHelpText:"Use Left/Right arrow keys to go backward/forward",timeSliderLabel:"Time Slider",volumeBeforeMute:.8,volumeGroup:0,volumeSliderHelpText:"Use Up/Down arrow keys to increase/decrease the volume",volumeHorizontal:!0,volumeSliderLabel:"Volume slider"},srcOptions$1={autoplay:!1,crossOrigin:void 0,download:{label:"Download",disabled:!1,hidden:!1,tooltip:{hidden:!1,left:!0}},duration:120,loop:!1,more:{label:{on:"Show less",off:"Show more"},tooltip:{hidden:!1,left:!0}},mute:{label:{on:"Unmute",off:"Mute"},disabled:!1,hidden:!1,tooltip:{hidden:!1,left:!0}},next:{label:"Next",disabled:!0,hidden:!0,tooltip:{hidden:!1,left:!1}},playbackRate:1,playPause:{label:{on:"Pause",off:"Play"},tooltip:{hidden:!1,left:!1}},preload:"none",previous:{label:"Previous",disabled:!0,hidden:!0,tooltip:{hidden:!1,left:!1}},settings:{hidden:!1,qualityLabel:"QUALITY",playbackRatesLabel:"PLAYBACK SPEED",playbackRates:[["0.25 x",.25],["0.5 x",.5],["0.75 x",.75],["Normal",1],["1.5 x",1.5],["2 x",2],["4 x",4]],subsLabel:"SUBTITLES"},skipTime:"1%",src:[],subtitles:{label:{on:"Disable subtitles",off:"Enable subtitles"},disabled:!1,hidden:!1,tooltip:{hidden:!1,left:!0},state:!1,wrapper:"",container:"",sources:[],default:"fr"},volume:.8,volumeForced:!1};class AudioDefaultOptions{static get instance(){return{...instanceOptions$1}}static get src(){return clone(srcOptions$1)}}let supportEventOptions=!1;document.createElement("div").addEventListener("test",(_=>{}),{get once(){return supportEventOptions=!0,!1}});let _$=context=>{context="string"==typeof context&&document.querySelector(context)?document.querySelector(context):context;return(selector=context)=>{const el="string"==typeof selector&&context.querySelector(selector)?context.querySelector(selector):selector;if(el.tagName)return el.css=newCSS=>{if("string"==typeof newCSS){let v=window.getComputedStyle(el,null).getPropertyValue(newCSS);return isNaN(parseFloat(v))?v:parseFloat(v)}return Object.assign(el.style,newCSS),el},el.setAttributes=attrs=>(Object.keys(attrs).forEach((key=>el.setAttribute(key,attrs[key]))),el),el.on=function(events,handler,options=!1){return events.split(" ").forEach((e=>{supportEventOptions?el.addEventListener(e,handler,options):!0===options.once?el.addEventListener(e,(function listener(){handler(),el.removeEventListener(e,listener)}),1==options.capture):el.addEventListener(e,handler,1==options.capture)})),el},el.off=function(events,handler){return events.split(" ").forEach((e=>el.removeEventListener(e,handler))),el},el}},_$$=context=>{context="string"==typeof context&&document.querySelector(context)?document.querySelector(context):context;return selector=>{const els=Array.isArray(selector)?selector:Array.from(context.querySelectorAll(selector));return els.css=newCSS=>{if("string"==typeof newCSS){let v=window.getComputedStyle(els[0],null).getPropertyValue(newCSS);return isNaN(parseFloat(v))?v:parseFloat(v)}return els.forEach((el=>Object.assign(el.style,newCSS))),els},els.on=function(events,handler,options=!1){return els.forEach((el=>events.split(" ").forEach((e=>{supportEventOptions?el.addEventListener(e,handler,options):!0===options.once?el.addEventListener(e,(function listener(){handler(),el.removeEventListener(e,listener)}),1==options.capture):el.addEventListener(e,handler,1==options.capture)})))),els},els.off=function(events,handler){return els.forEach((el=>events.split(" ").forEach((e=>el.removeEventListener(e,handler))))),els},els}};var _currentPointerType=new WeakMap,_data=new WeakMap;class PointerDetector extends EventEmitter{constructor(){if(!PointerDetector.pointerDetector){super(),_currentPointerType.set(this,{writable:!0,value:void 0}),_data.set(this,{writable:!0,value:{}});const w=window,s=w.sessionStorage,self=this,pointerEventsInterface=_classPrivateFieldGet(this,_data).pointerEventsInterface=w.PointerEvent?"pointer":w.TouchEvent?"touch":"mouse";if(_classPrivateFieldGet(this,_data).pointerenter="touch"==pointerEventsInterface?"none":pointerEventsInterface+"enter",_classPrivateFieldGet(this,_data).pointerleave="touch"==pointerEventsInterface?"none":pointerEventsInterface+"leave",_classPrivateFieldGet(this,_data).pointerup="touch"==pointerEventsInterface?"touchend":pointerEventsInterface+"up",_classPrivateFieldGet(this,_data).pointerdown="touch"==pointerEventsInterface?"touchstart":pointerEventsInterface+"down",_classPrivateFieldGet(this,_data).pointermove=pointerEventsInterface+"move",s.hasOwnProperty("amst__currentPointerType")||("pointer"==pointerEventsInterface?s.setItem("amst__currentPointerType","touch"):s.setItem("amst__currentPointerType",pointerEventsInterface)),_classPrivateFieldSet(this,_currentPointerType,s.getItem("amst__currentPointerType")),"pointer"==pointerEventsInterface){function getPointerType(e){if(e.pointerType==_classPrivateFieldGet(self,_currentPointerType))return!1;"mouse"==e.pointerType?w.removeEventListener("pointermove",getPointerType):w.addEventListener("pointermove",getPointerType),_classPrivateFieldSet(self,_currentPointerType,e.pointerType),s.setItem("amst__currentPointerType",e.pointerType),self.emit("amst__pointerChange")}"mouse"!=_classPrivateFieldGet(self,_currentPointerType)&&w.addEventListener("pointermove",getPointerType),w.addEventListener("pointerdown",getPointerType)}PointerDetector.pointerDetector=this}return PointerDetector.pointerDetector}get currentPointerType(){return _classPrivateFieldGet(this,_currentPointerType)}get data(){return _classPrivateFieldGet(this,_data)}}const pointerDetector=new PointerDetector;Object.freeze(pointerDetector);var _hidden=new WeakMap;class Button{constructor(name,player,ui,backgroundClass="amst__svg-background"){_hidden.set(this,{writable:!0,value:void 0}),backgroundClass=""===backgroundClass?"":` class="${backgroundClass}"`,ui.insertAdjacentHTML("beforeend",`<div role="button" class="amst__${name}" tabindex="0"><div${backgroundClass}></div></div>`),this.name=name,this.player=player,this.params=player.params[name],this.button=ui.querySelector(`.amst__${name}`),_classPrivateFieldSet(this,_hidden,this.params.hidden),this.button.addEventListener("click",(e=>this.player.emit(`amst__${name}-click`,this,e))),this.button.addEventListener("focus",(_=>this.player.emit("amst__focus"))),player.on(`amst__src-change amst__${name}-should-update`,(_=>this.update()))}update(label=this.params.label){const b=this.button,p=this.params;label&&b.setAttribute("aria-label",label),p.disabled&&!0===p.disabled?b.setAttribute("data-disabled",!0):b.removeAttribute("data-disabled"),!0===p.hidden?b.classList.add("amst__hidden"):b.classList.remove("amst__hidden"),p.tooltip&&!1===p.tooltip.hidden&&""!=label?(b.classList.add("amst__tooltip"),!0===p.tooltip.left?b.classList.add("amst__tooltip-left"):b.classList.remove("amst__tooltip-left")):b.classList.remove("amst__tooltip","amst__tooltip-left"),p.hidden!=_classPrivateFieldGet(this,_hidden)&&(_classPrivateFieldSet(this,_hidden,p.hidden),this.player.emit("amst__should-resize")),this.player.emit(`amst__${this.name}-update`,this)}}var _state$1=new WeakMap;class ToggleButton extends Button{constructor(name,player,ui,backgroundClass){super(name,player,ui,backgroundClass),_state$1.set(this,{writable:!0,value:!1})}update(){super.update(this.state?this.params.label.on:this.params.label.off)}get state(){return _classPrivateFieldGet(this,_state$1)}set state(state){if(state!=_classPrivateFieldGet(this,_state$1)){const b=this.button;state?b.classList.add("amst__on"):b.classList.remove("amst__on"),_classPrivateFieldSet(this,_state$1,state),this.update()}}}class MuteButton extends ToggleButton{constructor(player,ui){super("mute",player,ui);const playerParams=player.params,storage=window.sessionStorage;playerParams.isMobile&&(playerParams.volumeBeforeMute=1),playerParams.media.on("volumechange",(_=>{const v=player.volume;storage.setItem(`amst__volumegroup${playerParams.volumeGroup}`,v),v>.1&&!playerParams.isMobile&&(playerParams.volumeBeforeMute=v),this.state=player.muted})),player.on("amst__src-change",(_=>{!0!==playerParams.volumeForced&&storage.getItem(`amst__volumegroup${playerParams.volumeGroup}`)?storage.getItem(`amst__volumegroup${playerParams.volumeGroup}`)&&(playerParams.volume=Number(storage.getItem(`amst__volumegroup${playerParams.volumeGroup}`))):storage.setItem(`amst__volumegroup${playerParams.volumeGroup}`,playerParams.volume),player.volume=playerParams.volume,this.state=player.muted})).on("amst__mute-click",(_=>{(playerParams.isMobile||"mouse"==playerParams.currentPointerType||"horizontal"==playerParams.volumeOrientation)&&this.toggle()})),playerParams.$().on("keydown",(e=>{this.params.disabled||this.params.hidden||77!=e.which||(e.preventDefault(),this.toggle(),this.button.blur(),this.button.focus())}))}update(){const p=this.player.params;p.isMobile||(1==this.params.hidden?p.$(".amst__volume").classList.add("amst__hidden"):p.$(".amst__volume").classList.remove("amst__hidden")),super.update()}toggle(){this.state=!this.state,this.player.volume=this.state?0:this.player.params.volumeBeforeMute}}class Slider extends EventEmitter{constructor(player,ui,vertical=!1,reactiveArea){super(),ui.insertAdjacentHTML("beforeend",'\n      <div class="amst__slider" aria-valuemin="0" aria-valuemax="1" role="slider" tabindex="0">\n        <div class="amst__slider-total">\n          <div class="amst__slider-current"></div>\n        </div>\n      </div>\n    ');const self=this,$=_$(ui.querySelector(".amst__slider")),params=player.params;function referenceRectUpdate(){setTimeout((_=>{self.referenceRect=self.total.getBoundingClientRect()}),1)}this.params=params,this.slider=$(),this.total=$(".amst__slider-total"),this.current=$(".amst__slider-current"),this.referenceRect=this.total.getBoundingClientRect(),this.slider.on("focus",(_=>player.emit("amst__focus"))),reactiveArea=reactiveArea||$(),player.on("amst__resize",referenceRectUpdate),vertical&&reactiveArea.on(params.pointerenter,referenceRectUpdate),params.media.on("loadedmetadata",referenceRectUpdate),reactiveArea.on(params.pointerdown,(function(e){const ref=self.referenceRect,cleanEvents="pointerId"in e?`${params.pointerup}`:`${params.pointerleave} ${params.pointerup}`;function getRatio(e){let ratio;const x=e.clientX||e.pageX-window.pageXOffset,y=e.clientY||e.pageY-window.pageYOffset;x&&y&&(vertical?(ratio=y-ref.top,ratio=1-ratio/ref.height):(ratio=x-ref.left,ratio/=ref.width),ratio=Math.max(0,Math.min(ratio,1)),self.emit("amst__slider-change",ratio))}"pointerId"in e&&reactiveArea.setPointerCapture(e.pointerId),getRatio(e),reactiveArea.on(`${params.pointermove} ${params.pointerup}`,getRatio).on(cleanEvents,(function clean(){reactiveArea.off(`${params.pointermove} ${params.pointerup}`,getRatio).off(cleanEvents,clean)}))}))}}class VolumeSlider extends Slider{constructor(player,ui,vertical=!1){super(player,ui,vertical);const slider=this.slider,params=this.params,media=params.media,current=this.current;function update(){const v=Math.round(100*player.volume);current.style.width=v+"%",slider.setAttributes({"aria-valuenow":v/100,"aria-valuetext":v+"%"})}slider.setAttribute("aria-label",player.params.volumeSliderLabel),slider.insertAdjacentHTML("afterbegin",`<span class="amst__offscreen">${player.params.volumeSliderHelpText}</span>`),params.$().on("keydown",(e=>{if(!0!==params.mute.disabled&&!0!==params.mute.hidden){if(![38,40].includes(e.which)||e.shiftKey)return;switch(e.preventDefault(),slider.blur(),slider.focus(),e.which){case 40:player.volume=Math.max(0,player.volume-.05);break;case 38:player.volume=Math.min(1,player.volume+.05)}}}),!1),this.on("amst__slider-change",(vol=>player.volume=vol)),media.on("volumechange",update),player.on("amst__src-change",update),Object.defineProperty(params,"volumeSliderLabel",{writable:!1}),Object.defineProperty(params,"volumeSliderHelpText",{writable:!1})}}class VolumeButton extends VolumeSlider{constructor(player,ui){const params=player.params,volumeOrientation=!0!==params.volumeHorizontal?" amst__vertical":"";ui.insertAdjacentHTML("beforeend",`<div class="amst__volume${volumeOrientation}"><div class="amst__volume-wrapper"></div></div>`);const wrapper=ui.querySelector(".amst__volume-wrapper"),muteButton=new MuteButton(player,wrapper);super(player,wrapper," amst__vertical"==volumeOrientation),Object.defineProperty(params,"volumeHorizontal",{writable:!1});const slider=this.slider;let hideSliderTimeout=!1,clickTimeout=!1,timeNow=0;function hideSlider(){"vertical"!=params.volumeOrientation||params.isMobile||"mouse"==params.currentPointerType||(hideSliderTimeout&&clearTimeout(hideSliderTimeout),hideSliderTimeout=setTimeout((_=>{hideSliderTimeout=!1,slider.classList.remove("amst__show")}),params.hideControlsDelay))}params.media.on("volumechange",hideSlider),"vertical"==params.volumeOrientation&&("video"==params.type&&player.on("amst__controlsAreHidden",(_=>{"mouse"!=params.currentPointerType&&slider.classList.remove("amst__show")})),muteButton.button.addEventListener(params.pointerdown,(_=>{"mouse"!=params.currentPointerType&&(hideSliderTimeout&&clearTimeout(hideSliderTimeout),0==timeNow?(timeNow=Date.now(),clickTimeout=setTimeout((_=>{timeNow=0,slider.classList.toggle("amst__show"),slider.classList.contains("amst__show")&&(hideSlider(),window.dispatchEvent(new Event("amst__optimizedScrollResize")))}),250)):(clearTimeout(clickTimeout),clearTimeout(hideSliderTimeout),timeNow=0,muteButton.toggle(),slider.classList.remove("amst__show")))})))}}class TimeSlider extends Slider{constructor(player,ui){ui.insertAdjacentHTML("beforeend",'\n      <div class="amst__time amst__time-current" role="timer" aria-live="off"><span class="amst__currenttime"></span></div>\n      <div class="amst__time-rail">\n        <div class="amst__time-slider"></div>\n      </div>\n      <div class="amst__time amst__time-duration"><span class="amst__duration"></span></div>\n    ');const $=_$(ui.querySelector(".amst__time-slider"));super(player,$(),!1,$()),$(".amst__slider").insertAdjacentHTML("afterbegin",`<span class="amst__offscreen">${player.params.timeSliderHelpText}</span>`),$(".amst__slider").setAttribute("aria-label",player.params.timeSliderLabel),this.total.insertAdjacentHTML("afterbegin",'<canvas class="amst__loaded-bar"></canvas>'),this.total.insertAdjacentHTML("beforeend",'\n      <div class="amst__buffering-bar"></div>\n      <div class="amst__cursor"><div></div></div>\n      <div class="amst__seeking-wrapper">\n        <div class="amst__time amst__seeking">\n          <span></span>\n        </div>\n      </div>\n      <div class="amst__time-handler"></div>\n    ');const self=this,params=this.params,media=params.media,wrapper=params.$(),slider=this.slider,current=this.current,handler=$(".amst__time-handler"),cursor=$(".amst__cursor"),seeking=$(".amst__seeking-wrapper"),seekingTime=$(".amst__seeking-wrapper span");let buffered,seekingOffset,mustShowHours=params.alwaysShowHours;function updateDuration(){media.duration&&(params.duration=media.duration),mustShowHours=params.alwaysShowHours||params.duration>=3600,mustShowHours?params.$$(".amst__time").forEach((el=>el.classList.add("amst__long"))):params.$$(".amst__time").forEach((el=>el.classList.remove("amst__long"))),params.$(".amst__currenttime").innerHTML=secondsToTimeCode(media.currentTime||0,mustShowHours),params.$(".amst__duration").innerHTML=secondsToTimeCode(params.duration,mustShowHours),slider.setAttribute("aria-valuemax",params.duration),update(media.currentTime/params.duration)}player.on("amst__src-change",(_=>{this.off("amst__slider-change",update),buffered=void 0,seekingOffset=void 0,updateDuration()})),media.on("timeupdate",update).on("progress",updateBuffer).on("durationchange",updateDuration).on("loadedmetadata",(_=>this.on("amst__slider-change",update))).on("ended",(_=>{media.currentTime=0,player.pause()})),wrapper.on("keydown",(e=>{if(![37,39].includes(e.which)||!wrapper.classList.contains("amst__loadedmetadata"))return;e.preventDefault(),slider.blur(),slider.focus();const skipTime="string"==typeof params.skipTime&&"%"==params.skipTime.slice(-1)?parseInt(params.skipTime)*media.duration/100:parseInt(params.skipTime);switch(e.which){case 37:media.currentTime=Math.max(0,media.currentTime-skipTime);break;case 39:media.currentTime=Math.min(media.duration,media.currentTime+skipTime)}}),!1);const loadedBar=$(".amst__loaded-bar"),ctxLoadedBar=loadedBar.getContext("2d");function updateBuffer(){if(loadedBar.height||(loadedBar.height=loadedBar.offsetHeight,ctxLoadedBar.fillStyle=loadedBar.css("color")),!function(t1,t2){if(!t1||!t2||t1.length!=t2.length)return!1;for(let i=0;i<t1.length;i++)if(t1.start(i)!=t2.start(i)||t1.end(i)!=t2.end(i))return i=t1.length,!1;return!0}(media.buffered,buffered)){ctxLoadedBar.clearRect(0,0,loadedBar.width,loadedBar.height);let inc=loadedBar.width/media.duration;for(let i=0;i<media.buffered.length;i++){let start=media.buffered.start(i)*inc,width=media.buffered.end(i)*inc-start;new AmstRoundedRect(ctxLoadedBar,loadedBar.height,start,width)}buffered=media.buffered}}let updateTimeout,updateTimeRailAnimation;function update(ratio){if(cancelAnimationFrame(updateTimeRailAnimation),!params.duration)return;"number"==typeof ratio&&ratio>0&&(media.off("timeupdate",update),clearTimeout(updateTimeout),media.currentTime=ratio*params.duration,updateTimeout=setTimeout((_=>media.on("timeupdate",update)),50)),updateTimeRail(),updateBuffer();const currentTime=media.currentTime;params.$$(".amst__currenttime").forEach((el=>el.innerHTML=secondsToTimeCode(currentTime,mustShowHours))),slider.setAttributes({"aria-valuenow":currentTime,"aria-valuetext":secondsToTimeCode(currentTime)})}function updateTimeRail(){let ratio=media.currentTime/params.duration;ratio=Math.max(0,Math.min(ratio,1)),current.style.transform=`scaleX(${ratio})`,handler.style.transform=`translateX(${ratio*self.referenceRect.width}px)`,"video"==params.type&&self.emit("amst__time-slider-update",ratio),media.paused||(updateTimeRailAnimation=requestAnimationFrame(updateTimeRail))}loadedBar.height=0,"touch"!=params.pointerEventsInterface&&throttle(params.pointermove,"amst__optimizedPointerMove",$()),$().on("amst__optimizedPointerMove",(e=>{if(!media.duration||e.detail.pointerType&&"touch"==e.detail.pointerType)return;if(!seekingOffset){const cursorInner=$(".amst__cursor>div");seekingOffset=.5*seeking.css("width"),seekingOffset-=parseInt(window.getComputedStyle(cursorInner,":after").getPropertyValue("border-bottom-width")),seekingOffset-=.5*cursorInner.css("width")}let pos=(e.detail.clientX||e.detail.pageX-window.pageXOffset)-this.referenceRect.left;pos=Math.max(Math.min(pos,this.referenceRect.width),0);const ratio=pos/this.referenceRect.width;seekingTime.innerHTML=secondsToTimeCode(media.duration*ratio,mustShowHours),cursor.css({transform:`translateX(${pos}px)`}),pos=Math.max(pos,seekingOffset),pos=Math.min(pos,this.referenceRect.width-seekingOffset),seeking.css({transform:`translateX(${pos}px)`}),"video"==params.type&&this.emit("amst__move-over-time-slider",ratio)}))}}class AmstRoundedRect{constructor(ctx,h,x,w){ctx.beginPath(),ctx.moveTo(x+2,0),ctx.lineTo(x+w-2,0),ctx.quadraticCurveTo(x+w,0,x+w,2),ctx.lineTo(x+w,0+h-2),ctx.quadraticCurveTo(x+w,0+h,x+w-2,0+h),ctx.lineTo(x+2,0+h),ctx.quadraticCurveTo(x,0+h,x,0+h-2),ctx.lineTo(x,2),ctx.quadraticCurveTo(x,0,x+2,0),ctx.closePath(),ctx.fill()}}var _init$1=new WeakMap,_buildTextTracks=new WeakSet;class SubtitlesButton extends ToggleButton{constructor(player,ui){super("subtitles",player,ui),_buildTextTracks.add(this),_init$1.set(this,{writable:!0,value:!1});const _params=this.params,media=this.media=player.params.media;if(0==_params.sources.length){const subsSources=[],tracks=player.params.$$("track[src][srclang][label]",media);tracks.length>0&&tracks.forEach((t=>{subsSources.push({src:t.src,srclang:t.srclang,label:t.label}),t.default&&!_params.default&&(_params.default=t.srclang)})),_params.sources=subsSources}player.on("amst__src-change",(_=>function(receiver,privateSet,fn){if(!privateSet.has(receiver))throw new TypeError("attempted to get private field on non-instance");return fn}(this,_buildTextTracks,_buildTextTracks2).call(this))),player.on("amst__subtitles-click",(_=>this.state=!this.state))}get state(){return super.state}set state(state){state=state&&!this.params.hidden,this.wrapper&&(state?this.wrapper.classList.remove("amst__hide-subtitles"):this.wrapper.classList.add("amst__hide-subtitles")),super.state=this.params.state=state}update(){this.wrapper=null,this.container=null;const params=this.params;try{this.wrapper=document.querySelector(params.wrapper),this.container=document.querySelector(params.container)}catch(e){try{this.wrapper=this.player.params.$(".amst__subtitles-wrapper"),this.container=this.player.params.$(".amst__subtitles-container")}catch(e){}}params.hidden=params.hidden||0==params.sources.length||null==this.wrapper||null==this.container,this.state=params.state,super.update()}}var _buildTextTracks2=function(){if(_classPrivateFieldGet(this,_init$1)&&0==this.params.sources.length&&this.player.params.$$('track[kind="subtitles"]').forEach((t=>t.remove())),0==this.params.sources.length||!this.wrapper||!this.container)return;const params=this.params;!function(arr,key="label"){function compare(a,b){const valA=a[key].toUpperCase(),valB=b[key].toUpperCase();let comparison=0;return valA>valB?comparison=1:valA<valB&&(comparison=-1),comparison}try{arr.sort(compare)}catch(e){return arr}}(params.sources);let html="";params.sources.filter((s=>isString(s.src)&&isString(s.srclang)&&isString(s.label))).forEach((s=>{html+=`<track kind="subtitles" src="${s.src}" srclang="${s.srclang}" label="${s.label}" type="text/vtt">`})),this.media.innerHTML=html,this.wrapper.classList.add("amst__subtitles-empty");let activeTrack=null;const textTracks=this.media.textTracks;for(let i=0;i<textTracks.length;i++){const t=textTracks[i];t.mode="disabled",t.addEventListener("cuechange",(_=>{this.container.innerHTML="",t.activeCues.length>0&&this.container.appendChild(t.activeCues[0].getCueAsHTML()),""==this.container.innerHTML?this.wrapper.classList.add("amst__subtitles-empty"):this.wrapper.classList.remove("amst__subtitles-empty")})),t.language!=window.navigator.language&&t.language.split("-")[0]!=window.navigator.language.split("-")[0]||(activeTrack=t)}if(!activeTrack)for(let i=0;i<textTracks.length;i++){const t=textTracks[i];t.language!=params.default&&t.language.split("-")[0]!=params.default.split("-")[0]||(activeTrack=t)}activeTrack||(activeTrack=textTracks[0]),activeTrack.mode="hidden",_classPrivateFieldSet(this,_init$1,!0)};function isString(str){return"string"==typeof str&&""!=str}var _state=new WeakMap;class SettingsButton extends Button{constructor(player,ui){super("settings",player,ui),_state.set(this,{writable:!0,value:!1}),this.button.insertAdjacentHTML("beforeend",'<div class="amst__settings-display"><div></div><ul></ul></div>');const button=this.button,settingsWrapper=button.querySelector(".amst__settings-display"),$=player.params.$,nodal=this.nodal=player.params.nodal,self=this;function hide(){nodal.hide(),nodal.container.removeEventListener("click",onNodalClick),window.removeEventListener("click",onWindowClick),button.classList.remove("amst__on"),_classPrivateFieldSet(self,_state,!1)}function onWindowClick(e){let el=e.target;for(;el=el.parentNode;)if(el==self.settingsContainer)return;hide()}function onNodalClick(e){e.target==e.currentTarget&&hide(),e.target.hasAttribute("data-setting")&&!e.target.classList.contains("amst__selected")&&change(e)}function change(e){const setting=e.target.getAttribute("data-setting"),value=e.target.getAttribute("data-value"),media=player.params.media,oldLine=$(`li[data-setting="${setting}"].amst__selected`),oldValue="quality"==setting?oldLine.innerHTML:oldLine.getAttribute("data-value"),newLine=$(`li[data-value="${value}"]`),newValue="quality"==setting?newLine.innerHTML:value;if($(`li[data-setting="${setting}"].amst__selected`).classList.remove("amst__selected"),$(`li[data-value="${value}"]`).classList.add("amst__selected"),nodal.visible&&nodal.show("<ul>"+self.settingsContainer.innerHTML+"</ul>"),"playbackRate"==setting&&(media.playbackRate=parseFloat(value),player.emit("amst__playbackRate-change",oldValue,newValue),player.emit("amst__settings-change","playbackRate",oldValue,newValue)),"quality"==setting){const quality=e.target.textContent,s=window.sessionStorage,type=player.params.type,currentTime=media.currentTime,playbackRate=media.playbackRate,isPlaying=!player.paused,readyState=media.readyState>0;quality!=s.getItem(`amst__${type}DefaultQuality`)&&s.setItem(`amst__${type}DefaultQuality`,quality),isPlaying&&media.pause(),media.src=value,readyState&&media.load(),media.on("loadeddata",(function restoreCurrentTime(){media.off("loadeddata",restoreCurrentTime),media.currentTime=currentTime})),media.playbackRate=playbackRate,player.emit("amst__quality-change",oldValue,newValue),player.emit("amst__settings-change",setting,oldValue,newValue),isPlaying&&media.play()}if("subs"==setting){for(let i=0;i<media.textTracks.length;i++)media.textTracks[i].mode=media.textTracks[i].language==value?"hidden":"disabled",player.subtitles={state:!0};player.emit("amst__subs-change",oldValue,newValue),player.emit("amst__settings-change",setting,oldValue,newValue)}self.button.blur()}this.settingsContainer=settingsWrapper.querySelector("ul"),button.querySelector(".amst__svg-background").addEventListener(player.params.pointerup,(_=>{"mouse"!=player.params.currentPointerType&&(this.state?hide():function(){window.innerWidth<=720||window.innerHeight<=720?(nodal.show("<ul>"+self.settingsContainer.innerHTML+"</ul>"),setTimeout((_=>nodal.container.addEventListener("click",onNodalClick)),50)):setTimeout((_=>window.addEventListener("click",onWindowClick)),50);button.classList.add("amst__on"),_classPrivateFieldSet(self,_state,!0)}())})),this.settingsContainer.addEventListener("click",(e=>{e.target.hasAttribute("data-setting")&&!e.target.classList.contains("amst__selected")&&change(e)})),player.on("amst__src-change",hide).on("amst__resize",(function(){const rectTop=button.getBoundingClientRect().top,scrollTop=window.pageYOffset||document.documentElement.scrollTop;rectTop+scrollTop<350?settingsWrapper.classList.add("amst__align-bottom"):settingsWrapper.classList.remove("amst__align-bottom")}))}get state(){return _classPrivateFieldGet(this,_state)}update(){super.update();const params=this.params,media=this.player.params.media;if(this.settingsContainer.innerHTML="",!params.hidden){let listHTML="",sources=this.player.params.src.filter((el=>el.quality));if(params.playbackRates.length>0&&(listHTML=`\n          <li>\n            <span>${params.playbackRatesLabel}</span>\n            <ul>\n          `,params.playbackRates.forEach((el=>{const selected=(el=Array.isArray(el)?el:[el,parseFloat(el)])[1]==this.player.params.playbackRate?' class="amst__selected"':"";listHTML+=`<li data-setting="playbackRate" data-value="${el[1]}"${selected}>${el[0]}</li>`})),listHTML+="</ul></li>"),sources.length>1&&(listHTML+=`\n          <li>\n            <span>${params.qualityLabel}</span>\n            <ul>\n          `,sources.forEach((el=>{const id=media.src.lastIndexOf(el.src),selected=id>=0&&media.src.substring(0,id)+el.src==media.src?' class="amst__selected"':"";listHTML+=`<li data-setting="quality" data-value="${el.src}"${selected}>${el.quality}</li>`})),listHTML+="</ul></li>"),media.textTracks.length>1){listHTML+=`\n          <li>\n            <span>${params.subsLabel}</span>\n            <ul>\n          `;for(let i=0;i<media.textTracks.length;i++){const t=media.textTracks[i],selected="hidden"==t.mode?' class="amst__selected"':"";listHTML+=`<li data-setting="subs" data-value="${t.language}"${selected}>${t.label}</li>`}listHTML+="</ul></li>"}this.settingsContainer.innerHTML=listHTML,0==this.settingsContainer.childNodes.length&&this.button.classList.add("amst__hidden")}this.player.emit("amst__should-resize")}}throttle("resize scroll","amst__optimizedScrollResize");const w$2=window,d$1=document,s$3=w$2.sessionStorage;let timeWidth,longTimeWidth;if(s$3.getItem("amst__timeWidth"))timeWidth=s$3.getItem("amst__timeWidth"),longTimeWidth=s$3.getItem("amst__longTimeWidth");else{const measureTime=d$1.createElement("div"),measureLongTime=d$1.createElement("div");measureTime.classList.add("amst__measureTime"),measureTime.innerHTML="<span>00:00<span>",measureLongTime.classList.add("amst__measureTime"),measureLongTime.innerHTML="<span>00:00:00<span>",d$1.body.appendChild(measureTime),d$1.body.appendChild(measureLongTime),timeWidth=measureTime.offsetWidth+2,longTimeWidth=measureLongTime.offsetWidth+2,d$1.body.removeChild(measureTime),d$1.body.removeChild(measureLongTime),s$3.setItem("amst__timeWidth",timeWidth),s$3.setItem("amst__longTimeWidth",longTimeWidth)}const style=d$1.createElement("style");style.appendChild(d$1.createTextNode("")),d$1.head.appendChild(style),style.sheet.insertRule(`.amst__time>span{width:${timeWidth}px;`,0),style.sheet.insertRule(`.amst__time.amst__long>span{width:${longTimeWidth}px;`,0);class AudioUI{constructor(player){const self=this,params=player.params,$=params.$,$$=params.$$,media=params.media,container=$(".amst__container"),controls=$(d$1.createElement("div"));this.player=player,new Button("previous",player,controls);const playPauseButton=new ToggleButton("playPause",player,controls);player.on("amst__playPause-click",(button=>button.state?player.pause():player.play())),new Button("next",player,controls),this.timeSlider=new TimeSlider(player,controls),params.isMobile?new MuteButton(player,controls):new VolumeButton(player,controls);const additionalControls=$(d$1.createElement("div"));additionalControls.classList.add("amst__additional-controls"),new SubtitlesButton(player,additionalControls),this.settingsButton=new SettingsButton(player,additionalControls),new Button("download",player,additionalControls),player.on("amst__download-click",(b=>{if(!b.params.disabled){const a=d$1.createElement("a");a.href=media.src,a.download=decodeURI(media.src.substring(media.src.lastIndexOf("/")+1)),d$1.body.appendChild(a),a.click(),d$1.body.removeChild(a)}})),controls.appendChild(additionalControls),new ToggleButton("more",player,controls,""),player.on("amst__more-click",(b=>{b.state=!b.state,b.state?$().classList.add("amst__show-additional-controls"):$().classList.remove("amst__show-additional-controls")})),controls.classList.add("amst__controls"),container.appendChild(controls),container.insertAdjacentHTML("beforeend",`<div class="amst__error"><p>${params.errorMessage}</p></div>`),container.insertAdjacentHTML("beforeend",'<div class="amst__contextmenu"><a href="http://onfaitdessites.fr" target="_blank">AmstramgramMediaPlayer<br>by onFaitDesSites</a></div>');let animIsRunning=!1,contextCleanStyleTimeout=null;function resize(){if(0==container.getBoundingClientRect().height)return void setTimeout(resize,1);self.boundingRect=container.getBoundingClientRect();let playerWidth=self.boundingRect.width;playerWidth<=params.compactMaxWidth?($().classList.add("amst__compact"),playerWidth<=params.miniMaxWidth&&$$(".amst__additional-controls div[role=button]").length-$$(".amst__additional-controls div[role=button].amst__hidden").length>1?$().classList.add("amst__mini"):$().classList.remove("amst__mini")):($().classList.remove("amst__mini"),$().classList.remove("amst__compact")),player.emit("amst__resize")}$().on("contextmenu",(e=>{//!e.offsetX means obsolete browsers
if(e.preventDefault(),!e.offsetX||animIsRunning)return;let r,now;if(!animIsRunning){animIsRunning=!0,r=.3,now=Date.now();const rect=self.boundingRect,width=rect.width,height=rect.height,x=e.clientX||e.pageX-window.pageXOffset,y=e.clientY||e.pageY-window.pageYOffset,left=x-rect.left<.5*width?x-rect.left+5+"px":"unset",right=x-rect.left<.5*width?"unset":rect.right-x+5+"px",top=y-rect.top<.5*height?y-rect.top+10+"px":"unset",bottom=y-rect.top<.5*height?"unset":rect.bottom-y+10+"px",transform="none";width<450&&(left="50%",transform="translateX(-50%)"),$(".amst__contextmenu").css({left:left,right:right,top:top,bottom:bottom,transform:transform}).classList.add("amst__contextmenu-show"),contextCleanStyleTimeout&&clearTimeout(contextCleanStyleTimeout),w$2.requestAnimationFrame((function anim(){if(Date.now()-now<40)return void w$2.requestAnimationFrame(anim);now=Date.now(),r=Math.max(0,r-.03),$(".amst__contextmenu").css({filter:`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg'><filter id='n'><feTurbulence type='fractalNoise' baseFrequency='0 ${r}' result='N' numOctaves='2' /><feDisplacementMap in='SourceGraphic' in2='N' scale='100' xChannelSelector='R' yChannelSelector='R'></feDisplacementMap></filter></svg>#n")`}),r>0?w$2.requestAnimationFrame(anim):animIsRunning=!1}))}function removeContext(){w$2.removeEventListener("click",removeContext),player.off("amst__resize",removeContext),$(".amst__contextmenu").classList.remove("amst__contextmenu-show"),contextCleanStyleTimeout=setTimeout((()=>{$(".amst__contextmenu").removeAttribute("style")}),400)}w$2.addEventListener("click",removeContext),player.on("amst__resize",removeContext)})),$().on("keydown",(e=>{function setKeyboardIsInactive(){$().classList.remove("amst__keyboard-active"),w$2.removeEventListener(params.pointermove,setKeyboardIsInactive),w$2.removeEventListener(params.pointerdown,setKeyboardIsInactive)}$().classList.add("amst__keyboard-active"),w$2.addEventListener(params.pointermove,setKeyboardIsInactive,!1),w$2.addEventListener(params.pointerdown,setKeyboardIsInactive,!1),32==e.which&&(e.preventDefault(),playPauseButton.button.focus(),player.toggle())})),media.on("loadedmetadata",(_=>$().classList.add("amst__loadedmetadata"))).on("play playing seeked canplay",(_=>$().classList.remove("amst__buffering"))).on("seeking waiting loadeddata",(_=>$().classList.add("amst__buffering"))).on("error",(_=>{3==media.networkState&&(player.pause(),$().classList.remove("amst__buffering"),$().classList.add("amst__show-error"),player.emit("amst__error"))})),player.on("amst__src-change",(_=>{$().classList.remove("amst__loadedmetadata"),$().classList.remove("amst__show-error"),resize()})).on("amst__should-play",(_=>$().classList.add("amst__buffering"))).on("amst__play amst__should-play",(_=>playPauseButton.state=!0)).on("amst__pause",(_=>playPauseButton.state=!1)).on("amst__should-reset",(_=>this.reset())),player.on("amst__should-resize",resize),w$2.addEventListener("amst__optimizedScrollResize",resize)}reset(){const params=this.player.params,media=params.media,resetTime=media.currentTime,currentSrc=media.src;params.$().classList.remove("amst__loadedmetadata"),params.$().classList.remove("amst__buffering"),media.src="",media.preload="none",media.autoplay=!1,media.load(),media.src=currentSrc;try{media.currentTime=resetTime}catch(e){media.addEventListener("loadedmetadata",(function restoreCurrentTime(){media.removeEventListener("loadedmetadata",restoreCurrentTime),media.currentTime=resetTime}))}this.player.emit("amst__reset")}}var _visible=new WeakMap;class Nodal{constructor(){return _visible.set(this,{writable:!0,value:!1}),Nodal.nodal||(this.container=document.createElement("div"),this.container.classList.add("amst__hidden"),this.container.setAttribute("data-role","amst__nodal"),document.body.appendChild(this.container),Nodal.nodal=this),Nodal.nodal}show(html){this.container.innerHTML=html,this.container.classList.remove("amst__hidden"),document.body.classList.add("amst__overflow-hidden"),_classPrivateFieldSet(this,_visible,!0)}hide(){this.container.innerHTML="",this.container.classList.add("amst__hidden"),document.body.classList.remove("amst__overflow-hidden"),_classPrivateFieldSet(this,_visible,!1)}get visible(){return _classPrivateFieldGet(this,_visible)}}const nodal=new Nodal;Object.freeze(nodal);const w$1=window,s$2=w$1.sessionStorage,UA=w$1.navigator.userAgent.toLowerCase(),isIos=/ipad|iphone|ipod/i.test(UA)&&!w$1.MSStream,isMobile=isIos||/android/i.test(UA),isIE=UA.indexOf("MSIE ")>0||!!navigator.userAgent.match(/Trident.*rv\:11\./);var _init=new WeakMap,_paused=new WeakMap;class AmstramgramAudioPlayer extends EventEmitter{static get booleanAttributes(){return["autoplay","loop"]}static get stringAttributes(){return["crossOrigin","preload","type"]}static get attributesToUpdate(){return["crossOrigin","loop","preload","type"]}static get buttons(){return Object.keys(this.srcOptions).filter((k=>isObject(this.srcOptions[k])&&(this.srcOptions[k].hasOwnProperty("label")||this.srcOptions[k].hasOwnProperty("hidden"))))}static get instanceOptions(){return clone(_classStaticPrivateFieldSpecGet(this,AmstramgramAudioPlayer,_instanceOptions$1))}static get srcOptions(){return clone(_classStaticPrivateFieldSpecGet(this,AmstramgramAudioPlayer,_srcOptions$1))}static set options(opt){new Array(_classStaticPrivateFieldSpecGet(this,AmstramgramAudioPlayer,_instanceOptions$1),_classStaticPrivateFieldSpecGet(this,AmstramgramAudioPlayer,_srcOptions$1)).forEach((obj=>{mergeDeep(obj,opt)}))}static get options(){return{...this.instanceOptions,...this.srcOptions}}static get players(){return[..._classStaticPrivateFieldSpecGet(this,AmstramgramAudioPlayer,_players)]}static get currentPlayer(){return _classStaticPrivateFieldSpecGet(this,AmstramgramAudioPlayer,_currentPlayer)}constructor(media,params={},callback,WrappingClass){if("function"==typeof params&&(callback=params,params={}),super(),_init.set(this,{writable:!0,value:!1}),_paused.set(this,{writable:!0,value:!0}),!media||"AUDIO"!=media.tagName&&"VIDEO"!=media.tagName)return;if(!WrappingClass&&"AUDIO"!=media.tagName)return;if(WrappingClass&&"AmstramgramMediaPlayer"!=WrappingClass.name)return;if(WrappingClass&&(!callback||"function"!=typeof callback))return;const Class=this.constructor,myParams=clone(Class.options),$=_$(document.createElement("div"));_$$($());let classes="amst__wrapper";window.document.documentMode&&(classes+=" amst__ie"),$().setAttributes({class:classes,"aria-label":`${myParams.appLabel}`,role:"application"}).insertAdjacentHTML("beforeend",`\n        <span class="amst__offscreen">${myParams.appLabel}</span>\n        <div class="amst__container" tabindex="0">\n          <div class="amst__mediaelement"></div>\n        </div>\n      `),media.parentNode.insertBefore($(),media),$(".amst__mediaelement").appendChild(media),myParams.$=$,myParams.$$=_$$($()),myParams.media=$(media),myParams.isIos=isIos,myParams.isMobile=isMobile,myParams.isIE=isIE,myParams.type=Class==AmstramgramAudioPlayer?"audio":"video",media.controls=!1,params=buildSrcParams(params,media,!1),media.muted&&(!isNaN(params.volume)&&params.volume>0&&params.volume<=1?media.muted=!1:params.volume=0,media.removeAttribute("muted")),Class.booleanAttributes.forEach((a=>{params[a]="boolean"==typeof params[a]?params[a]:1==media[a]||void 0,Class.attributesToUpdate.includes(a)||media.removeAttribute(a)})),Class.stringAttributes.forEach((a=>{params[a]="string"==typeof params[a]?params[a]:media.getAttribute(a),Class.attributesToUpdate.includes(a)||media.removeAttribute(a)})),mergeDeep(myParams,params),Object.assign(myParams,pointerDetector.data),myParams.currentPointerType=pointerDetector.currentPointerType,myParams.nodal=nodal;const ordered={};Object.keys(myParams).sort().forEach((function(key){ordered[key]=myParams[key]})),this.params=ordered;const self=this;if("pointer"==pointerDetector.data.pointerEventsInterface){function onPointerChange(){self.params.currentPointerType=pointerDetector.currentPointerType,"mouse"==pointerDetector.currentPointerType?$().classList.add("amst__mouse"):$().classList.remove("amst__mouse")}pointerDetector.on("amst__pointerChange",onPointerChange),onPointerChange()}else"mouse"==pointerDetector.pointerEventsInterface&&$().classList.add("amst__mouse");_classStaticPrivateFieldSpecGet(AmstramgramAudioPlayer,AmstramgramAudioPlayer,_players).push(this),this._buildUI(),this.src=this.params,this.constructor.buttons.forEach((k=>{Object.defineProperty(this,k,{set:opt=>{let o={};o[k]=opt,mergeDeep(this.params,o),this.emit(`amst__${k}-should-update`)}})})),_classPrivateFieldSet(this,_init,!0),callback&&"function"==typeof callback&&setTimeout((_=>{callback.call(this),1==this.params.autoplay&&setTimeout((_=>self.play()),1)}),1)}_buildUI(){this.constructor!=AmstramgramAudioPlayer||this.init||(new AudioUI(this),this.params.$().classList.add("amst__audio"))}get init(){return _classPrivateFieldGet(this,_init)}set currentTime(t){try{this.params.media.currentTime=t}catch(e){console.warn(e)}}get currentTime(){return this.params.media.currentTime}set muted(bool){"boolean"==typeof bool&&(this.params.media.muted=bool)}get muted(){return this.params.media.muted}get paused(){return _classPrivateFieldGet(this,_paused)}get playbackRate(){return this.params.media.playbackRate}set playbackRate(rate){this.params.media.playbackRate=rate}get src(){return this.params.media.src}set src(src){this.pause();const params=this.params,media=params.media,type=params.type;try{this.params.media.currentTime=0}catch(e){}if(this.init){src=buildSrcParams(src,media);const mySrc=this.constructor.srcOptions;mergeDeep(mySrc,src),mergeDeep(params,mySrc)}if(0==params.src.length)return void params.$().classList.add("amst__show-error");let rightSrc=params.src.find((el=>el.quality&&el.quality==s$2.getItem(`amst__${type}DefaultQuality`)))||params.src.find((el=>1==el.default))||params.src[0];rightSrc.quality&&rightSrc.quality!=s$2.getItem(`amst__${type}DefaultQuality`)&&s$2.setItem(`amst__${type}DefaultQuality`,rightSrc.quality),rightSrc.type?media.setAttribute("type",rightSrc.type):media.removeAttribute("type"),media.src=rightSrc.src,media.playbackRate=params.playbackRate,this.constructor.attributesToUpdate.forEach((a=>{media[a]=params[a]})),this.emit("amst__src-change"),this.init&&1==params.autoplay&&this.play()}get volume(){return this.params.media.muted?0:this.params.media.volume}set volume(vol){if(isNaN(vol)||vol<0||vol>1||vol==this.volume||this.params.isMobile&&0!=vol&&1!=vol)return;const params=this.params,media=params.media;vol>0&&(media.volume=vol,media.muted&&(media.muted=!1)),0!=vol||media.muted||(media.muted=!0),AmstramgramAudioPlayer.players.filter((p=>p!=this&&p.params.volumeGroup==params.volumeGroup&&p.volume!=vol)).forEach((p=>p.volume=vol))}hideControls(){}pause(){this.paused||(_classPrivateFieldSet(this,_paused,!0),this.params.media.paused||this.params.media.pause(),this.emit("amst__pause"))}play(){if(this.paused&&this.src){const self=this;if(this.params.media.paused){AmstramgramAudioPlayer.currentPlayer&&this!=AmstramgramAudioPlayer.currentPlayer&&(AmstramgramAudioPlayer.currentPlayer.pause(),AmstramgramAudioPlayer.currentPlayer.emit("amst__should-reset")),_classPrivateFieldSet(this,_paused,!1),this.emit("amst__should-play");const media=this.params.media;function playIt(){const playPromise=media.play();void 0!==playPromise?playPromise.then(playSucceed).catch((e=>{self.emit("amst__pause")})):playSucceed()}0!=media.readyState||isIE?playIt():(media.on("loadeddata",(function onDataLoaded(){media.off("loadeddata",onDataLoaded),playIt()})),media.load())}function playSucceed(){var receiver,descriptor,value;self.emit("amst__play"),descriptor=_currentPlayer,value=self,_classCheckPrivateStaticAccess(receiver=AmstramgramAudioPlayer,AmstramgramAudioPlayer),_classCheckPrivateStaticFieldDescriptor(descriptor,"set"),_classApplyDescriptorSet(receiver,descriptor,value)}}}showControls(){}toggle(){this.paused?this.play():this.pause()}}var _instanceOptions$1={writable:!0,value:AudioDefaultOptions.instance},_srcOptions$1={writable:!0,value:AudioDefaultOptions.src},_players={writable:!0,value:[]},_currentPlayer={writable:!0,value:void 0};const instanceOptions={...AudioDefaultOptions.instance,appLabel:"Video player",touchSeekingInfoText:"Tap & go !"},srcOptions={...AudioDefaultOptions.src,format:16/9,fullscreen:{label:{on:"Exit fullscreen",off:"Fullscreen"},disabled:!1,hidden:!1,tooltip:{hidden:!1,left:!0}},playsInline:!0,poster:"",thumbnails:{src:void 0,width:120,int:0}};"pictureInPictureEnabled"in document&&(srcOptions.pip={label:{on:"Disable PIP",off:"PIP"},disabled:!1,hidden:!1,tooltip:{hidden:!1,left:!0}});class VideoDefaultOptions{static get instance(){return{...instanceOptions}}static get src(){return clone(srcOptions)}}class PipButton extends ToggleButton{constructor(player,ui){super("pip",player,ui);const media=player.params.media;function exitPIP(){document.exitPictureInPicture().catch((_=>{}))}media.on("loadedmetadata",(_=>{this.params.disabled||this.button.removeAttribute("data-disabled")})).on("enterpictureinpicture",(_=>this.state=!0)).on("leavepictureinpicture",(_=>this.state=!1)),player.on("amst__src-change",(_=>{this.state&&exitPIP(),setTimeout((_=>this.button.setAttribute("data-disabled",!0)),1)})).on("amst__pip-click",(b=>{b.state?exitPIP():media.requestPictureInPicture().catch((_=>{}))}))}update(){super.update(),this.player.params.$().classList.contains("amst__loadedmetadata")||this.params.disabled||this.button.setAttribute("data-disabled",!0)}}const w=window,d=document,s$1=w.sessionStorage;let fullscreenAPI;s$1&&null!=s$1.getItem("amst_fullscreenAPI")?fullscreenAPI=JSON.parse(s$1.getItem("amst_fullscreenAPI")):(fullscreenAPI=function(){let val,fnMap=[["requestFullscreen","exitFullscreen","fullscreenElement","fullscreenchange"],["webkitRequestFullscreen","webkitExitFullscreen","webkitFullscreenElement","webkitfullscreenchange"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitCurrentFullScreenElement","webkitfullscreenchange"],["mozRequestFullScreen","mozCancelFullScreen","mozFullScreenElement","mozfullscreenchange"],["msRequestFullscreen","msExitFullscreen","msFullscreenElement","MSFullscreenChange"]],i=0,l=fnMap.length,ret={};for(;i<l;i++)if(val=fnMap[i],val&&val[1]in document){for(i=0;i<val.length;i++)ret[fnMap[0][i]]=val[i];return ret}return{fake:!0}}(),s$1&&s$1.setItem("amst_fullscreenAPI",JSON.stringify(fullscreenAPI)));var _isFullscreen=new WeakMap;class FullscreenButton extends ToggleButton{constructor(player,ui){super("fullscreen",player,ui),_isFullscreen.set(this,{writable:!0,value:!1});const self=this,playerParams=player.params,$=playerParams.$,container=$(".amst__container"),nodal=playerParams.nodal;player.on("amst__fullscreen-click",(_=>{this.state?fullscreenAPI.fake?leaveFullscreen():d[fullscreenAPI.exitFullscreen]():function(){scrollX=w.pageXOffset,scrollY=w.pageYOffset,fullscreenAPI.fake?($().classList.add("amst__fake-fullscreen"),w.addEventListener("keydown",windowOnKeydown),_classPrivateFieldSet(self,_isFullscreen,!0)):$()[fullscreenAPI.requestFullscreen]();d.body.classList.add("amst__overflow-hidden"),$().appendChild(nodal.container),$().classList.add("amst__isfullscreen"),self.state=!0,resizeFullScreen(),player.on("amst__resize",resizeFullScreen),player.emit("amst__should-resize"),player.emit("amst__fullscreen-enter")}()}));let scrollX=0,scrollY=0;function leaveFullscreen(){player.off("amst__resize",resizeFullScreen),self.state=!1,fullscreenAPI.fake&&($().classList.remove("amst__fake-fullscreen"),w.removeEventListener("keydown",windowOnKeydown)),d.body.classList.remove("amst__overflow-hidden"),container.setAttribute("style",`padding-bottom:${1/playerParams.format*100}%`),document.body.appendChild(nodal.container),$().classList.remove("amst__isfullscreen"),setTimeout((_=>{w.scroll(scrollX,scrollY),player.emit("amst__should-resize"),player.emit("amst__fullscreen-exit")}),50)}function resizeFullScreen(){w.innerWidth/w.innerHeight>playerParams.format?container.css({width:w.innerHeight*playerParams.format+"px",height:"100%",paddingBottom:0}):container.css({width:"100%",height:"auto",paddingBottom:1/playerParams.format*100+"%"})}function windowOnKeydown(e){27==e.which&&fullscreenAPI.fake&&_classPrivateFieldGet(self,_isFullscreen)&&leaveFullscreen()}d.addEventListener(fullscreenAPI.fullscreenchange,(_=>{_classPrivateFieldGet(this,_isFullscreen)?(leaveFullscreen(),_classPrivateFieldSet(this,_isFullscreen,!1)):d[fullscreenAPI.fullscreenElement]==$()&&_classPrivateFieldSet(this,_isFullscreen,!0)}))}}const s=window.sessionStorage;class VideoUI extends AudioUI{static get showTouchSeekingInfo(){return!s.hasOwnProperty("amst__hideTouchSeekingInfo")}static hideTouchSeekingInfo(){s.hasOwnProperty("amst__hideTouchSeekingInfo")||(s.setItem("amst__hideTouchSeekingInfo","true"),this.videoUIs.forEach((ui=>{const $=ui.player.params.$;$(".amst__layer-overlay").removeChild($(".amst__layer-overlay .amst__seeking-touch-info"))})))}static get videoUIs(){return[..._classStaticPrivateFieldSpecGet(this,VideoUI,_videoUIs)]}constructor(player){const params=player.params,media=params.media,$=params.$,$$=params.$$,container=$(".amst__container");let layersHtml=`\n      <div class="amst__layers">\n        <div class="amst__layer-poster amst__hidden">\n          <canvas></canvas>\n        </div>\n        <div class="amst__layer-loading amst__layer-scale">\n          <div class="amst__loading">\n            <span class="amst__svg"></span>\n          </div>\n        </div>\n        <div class="amst__layer-play amst__layer-scale">\n          <div class="amst__svg" role="button" tabindex="0" aria-label="${params.playPause.label.off}"></div>\n        </div>\n        <div class="amst__layer-subtitles">\n          <div class="amst__subtitles-wrapper">\n            <span class="amst__subtitles-container"></span>\n          </div>\n        </div>\n        <div class="amst__layer-overlay">\n      `;!0===VideoUI.showTouchSeekingInfo&&(layersHtml+=`\n          <div class="amst__seeking-touch-info">\n            <span>${params.touchSeekingInfoText}</span>\n          </div>\n        `),layersHtml+='   \n          <div class="amst__seeking-touch-cover"></div>\n          <div class="amst__seeking-touch-wrapper">\n            <div class="amst__time amst__seeking">\n              <span></span>\n            </div>\n          </div>\n          <div class="amst__seeking-time-display-wrapper">\n            <div class="amst__seeking-time-display"></div>\n          </div>\n        </div>\n      </div>\n    ',container.insertAdjacentHTML("beforeend",layersHtml),super(player);const d=document,layerPoster=$(".amst__layer-poster"),layerPosterCanvas=$(".amst__layer-poster canvas"),layerPlay=$(".amst__layer-play"),layerOverlay=$(".amst__layer-overlay"),seekingTouchCover=$(".amst__seeking-touch-cover"),seekingTouchWrapper=$(".amst__seeking-touch-wrapper"),controls=$(".amst__controls"),timeSlider=this.timeSlider,seekings=$$(".amst__seeking"),self=this;function toggle(){"mouse"!=params.currentPointerType&&controlsAreHidden?showControls():player.toggle()}let playerWidth;function resize(){playerWidth=self.boundingRect.width;let scale=.3*Math.min(playerWidth,self.boundingRect.height)/90;scale=Math.max(.4,Math.min(1,scale)),1==scale?[...$$(".amst__layer-scale"),...$$(".amst__layer-scale > div")].forEach((el=>el.removeAttribute("style"))):($$(".amst__layer-scale").css({height:`calc(100% - ${controls.css("height")}px`}),$$(".amst__layer-scale > div").css({transform:`scale(${scale})`}));let subFontSize=Math.round(24*playerWidth/1e3);subFontSize=Math.min(Math.max(subFontSize,14),30)+"px",$(".amst__subtitles-container").style.fontSize=subFontSize}function updateThumbnails(ratio){const offset=params.thumbnails.width*Math.floor(ratio*media.duration/params.thumbnails.int);seekings.css({backgroundPositionX:-offset+"px"})}function removeThumbnails(){$().classList.remove("amst__thumbnails"),timeSlider.off("amst__move-over-time-slider",updateThumbnails),seekings.forEach((el=>el.removeAttribute("style")))}"pictureInPictureEnabled"in d&&new PipButton(player,$(".amst__additional-controls")),new FullscreenButton(player,controls),layerOverlay.on("click",toggle),media.on("loadedmetadata",(_=>{params.format=media.videoWidth/media.videoHeight,container.style.paddingBottom=1/params.format*100+"%",player.emit("amst__should-resize")})).on("seeked",(()=>{0==media.currentTime&&media.paused?(layerPosterCanvas.width=0,layerPosterCanvas.height=0,layerPoster.classList.remove("amst__hidden"),media.on("timeupdate",(function hidePoster(){media.off("timeupdate",hidePoster),layerPoster.classList.add("amst__hidden")}))):"mouse"!=params.currentPointerType&&hideControls(!0)})).on("playing volumechange",(()=>{"mouse"!=params.currentPointerType&&hideControls(!0)})),player.on("amst__play amst__should-play",(_=>{layerPlay.classList.add("amst__hidden"),layerPoster.classList.add("amst__hidden"),controlsAreHidden||hideControls(!0)})).on("amst__pause",(_=>{layerPlay.classList.remove("amst__hidden"),showControls()})).on("amst__focus amst__showControls",showControls).on("amst__hideControls",hideControls).on("amst__resize",resize),player.on("amst__src-change",(_=>{container.style.paddingBottom=1/params.format*100+"%",params.poster?(layerPoster.style.backgroundImage=`url("${params.poster}")`,layerPoster.classList.remove("amst__hidden")):(layerPoster.removeAttribute("style"),layerPoster.classList.add("amst__hidden"));const paramsThumbnails=params.thumbnails;if(paramsThumbnails.src&&paramsThumbnails.width>0&&paramsThumbnails.int>0){const thumbnailsImage=new Image;function onThumbLoad(e){if(thumbnailsImage.removeEventListener("load",onThumbLoad),thumbnailsImage.removeEventListener("error",onThumbLoad),"load"==e.type&&e.target.getAttribute("src")==paramsThumbnails.src){$().classList.add("amst__thumbnails");const css={width:`${paramsThumbnails.width}px`,height:`${thumbnailsImage.naturalHeight}px`,"background-image":`url("${paramsThumbnails.src}")`};seekings.css(css),timeSlider.on("amst__move-over-time-slider",updateThumbnails)}else removeThumbnails()}thumbnailsImage.addEventListener("error",onThumbLoad,!1),thumbnailsImage.addEventListener("load",onThumbLoad,!1),thumbnailsImage.src=paramsThumbnails.src}else removeThumbnails();self.boundingRect&&resize()}));let hideControlsTimeOut=!1,pointerOverControls=!1,controlsAreHidden=!1;function hideControls(delayed=!1,forced=!1){media.paused&&!forced||(delayed||$().classList.contains("amst__buffering")||pointerOverControls||self.settingsButton.state?(hideControlsTimeOut&&clearTimeout(hideControlsTimeOut),hideControlsTimeOut=setTimeout(hideControls,params.hideControlsDelay),layerOverlay.style.touchAction="pan-down"):(hideControlsTimeOut&&(clearTimeout(hideControlsTimeOut),hideControlsTimeOut=!1),$().off("keydown",hideControlsOnArrowDown).on("keydown",showControlsOnArrowUp).classList.add("amst__controls-hidden"),layerOverlay.style.touchAction="pan-up",controlsAreHidden=!0,player.emit("amst__controlsAreHidden")))}function showControls(){hideControlsTimeOut&&(clearTimeout(hideControlsTimeOut),hideControlsTimeOut=!1),$().on("keydown",hideControlsOnArrowDown).off("keydown",showControlsOnArrowUp).classList.remove("amst__controls-hidden"),controlsAreHidden=!1,player.emit("amst__controlsAreVisible"),media.paused?layerOverlay.style.touchAction="auto":hideControls(!0)}function showControlsOnArrowUp(e){38==e.which&&e.shiftKey&&showControls()}function hideControlsOnArrowDown(e){40==e.which&&e.shiftKey&&hideControls()}if("touch"!=params.pointerEventsInterface&&(controls.on(params.pointerenter,(_=>{"mouse"==params.currentPointerType&&(pointerOverControls=!0)})).on(params.pointerleave,(_=>{"mouse"==params.currentPointerType&&(hideControls(!0),pointerOverControls=!1)})),layerOverlay.on(params.pointermove,(_=>{"mouse"==params.currentPointerType&&showControls()}))),controls.on(params.pointerdown,showControls),"mouse"!=params.pointerEventsInterface){const threshold=20;let touchStartX,touchStartY,seekingWidth,ratio,tapAndGoTimer,controlsWereHidden=!1;function onTouchMove(e){const distX=Math.abs(e.changedTouches[0].clientX-touchStartX),distY=Math.abs(e.changedTouches[0].clientY-touchStartY),playerLeftPosition=self.boundingRect.left;if(distX>threshold&&distY<.25*distX||null!=ratio){null==ratio&&(media.currentTime,media.duration,controlsWereHidden=controlsAreHidden,controlsAreHidden||hideControls(!1,!0),layerOverlay.classList.add("amst__show")),ratio=(e.changedTouches[0].clientX-playerLeftPosition)/playerWidth,ratio=Math.min(Math.max(ratio,0),1),seekingTouchCover.style.transform=`scaleX(${ratio})`,$(".amst__seeking-touch-wrapper span").innerHTML=secondsToTimeCode(media.duration*ratio,params.hoursTimeDisplay||media.duration>3600);let translate=ratio*playerWidth-.5*seekingWidth;translate=Math.max(0,Math.min(playerWidth-seekingWidth,translate)),seekingTouchWrapper.style.transform=`translateX(${translate}px)`,updateThumbnails(ratio)}else distY>threshold&&distX<.25*distY&&(e.changedTouches[0].clientY>touchStartY?media.paused||controlsAreHidden||hideControls():controlsAreHidden&&showControls())}function onTouchEnd(e){if(layerOverlay.off("touchend touchcancel",onTouchEnd),layerOverlay.off("touchmove",onTouchMove),null!=ratio){function onClick(){null!=ratio&&(media.currentTime=media.duration*ratio),VideoUI.showTouchSeekingInfo&&VideoUI.hideTouchSeekingInfo(),clean()}function clean(){clearTimeout(tapAndGoTimer),tapAndGoTimer=ratio=void 0,layerOverlay.off("click",onClick).on("click",toggle).classList.remove("amst__show"),controlsWereHidden||showControls()}layerOverlay.off("click",toggle),layerOverlay.on("click",onClick),tapAndGoTimer=setTimeout(clean,400)}}layerOverlay.on("touchstart",(e=>{media.duration&&!tapAndGoTimer&&(seekingWidth=seekingTouchWrapper.offsetWidth,touchStartX=e.changedTouches[0].clientX,touchStartY=e.changedTouches[0].clientY,layerOverlay.on("touchend touchcancel",onTouchEnd),layerOverlay.on("touchmove",onTouchMove))}))}this.timeSlider.on("amst__time-slider-update",(ratio=>{$(".amst__seeking-time-display").style.transform=`scaleX(${ratio})`})),_classStaticPrivateFieldSpecGet(VideoUI,VideoUI,_videoUIs).push(this)}reset(){const media=this.player.params.media,layer=this.player.params.$(".amst__layer-poster"),canvas=this.player.params.$(".amst__layer-poster canvas");canvas.width=media.videoWidth,canvas.height=media.videoHeight,canvas.getContext("2d").drawImage(media,0,0,canvas.width,canvas.height),layer.classList.remove("amst__hidden"),super.reset()}}var _videoUIs={writable:!0,value:[]};class AmstramgramVideoPlayer extends AmstramgramAudioPlayer{static get booleanAttributes(){return[...AmstramgramAudioPlayer.booleanAttributes,"playsInline"]}static get stringAttributes(){return[...AmstramgramAudioPlayer.stringAttributes,"poster"]}static get attributesToUpdate(){return[...AmstramgramAudioPlayer.attributesToUpdate,"playsInline"]}static get instanceOptions(){return clone(_classStaticPrivateFieldSpecGet(this,AmstramgramVideoPlayer,_instanceOptions))}static get srcOptions(){return clone(_classStaticPrivateFieldSpecGet(this,AmstramgramVideoPlayer,_srcOptions))}static set options(opt){new Array(_classStaticPrivateFieldSpecGet(this,AmstramgramVideoPlayer,_instanceOptions),_classStaticPrivateFieldSpecGet(this,AmstramgramVideoPlayer,_srcOptions)).forEach((obj=>{mergeDeep(obj,opt)}))}static get options(){return{...this.instanceOptions,...this.srcOptions}}constructor(media,params={},callback,WrappingClass){super(media,params,callback,WrappingClass),"VIDEO"==media.tagName&&callback&&"function"==typeof callback&&WrappingClass&&WrappingClass.name}_buildUI(){this.constructor!=AmstramgramVideoPlayer||this.init||(new VideoUI(this),this.params.$().classList.add("amst__video"))}hideControls(){this.emit("amst__hideControls")}showControls(){this.emit("amst__showControls")}}var _instanceOptions={writable:!0,value:VideoDefaultOptions.instance},_srcOptions={writable:!0,value:VideoDefaultOptions.src};function getDescriptor(prop,instance){let descriptor,proto=Object.getPrototypeOf(instance);for(;Object.getPrototypeOf(proto)&&!descriptor;)descriptor=Object.getOwnPropertyDescriptor(proto,prop),proto=Object.getPrototypeOf(proto);return descriptor}class AmstramgramMediaPlayer extends EventEmitter{static set options(params){AmstramgramAudioPlayer.options=params,AmstramgramVideoPlayer.options=params}static get options(){return{audio:AmstramgramAudioPlayer.options,video:AmstramgramVideoPlayer.options}}static set audioOptions(params){AmstramgramAudioPlayer.options=params}static get audioOptions(){return AmstramgramAudioPlayer.options}static set videoOptions(params){AmstramgramVideoPlayer.options=params}static get videoOptions(){return AmstramgramVideoPlayer.options}static get players(){return AmstramgramAudioPlayer.players}static get currentPlayer(){return AmstramgramAudioPlayer.currentPlayer}constructor(media,params={},callback){if(super(),!media||"AUDIO"!=media.tagName&&"VIDEO"!=media.tagName)return;const self=this;function onPlayerInit(){(function(instance,stop){let array=[],proto=Object.getPrototypeOf(instance);for(;proto&&proto!==stop;)Object.getOwnPropertyNames(proto).forEach((name=>{"constructor"!==name&&"_"!=name.charAt(0)&&array.push(name)})),proto=Object.getPrototypeOf(proto);return array.filter((function(item,i,ar){return ar.indexOf(item)===i}))})(this,Object.getPrototypeOf(AmstramgramAudioPlayer.prototype)).forEach((m=>{let desc={};getDescriptor(m,this).set&&(desc.set=val=>this[m]=val),getDescriptor(m,this).get&&(desc.get=_=>this[m]),getDescriptor(m,this).value&&(desc.value=_=>this[m]()),Object.defineProperty(self,m,desc)})),Object.getOwnPropertyNames(this).forEach((p=>{let desc={};Object.getOwnPropertyDescriptor(this,p).set&&(desc.set=val=>this[p]=val),Object.getOwnPropertyDescriptor(this,p).value&&(desc.value=this[p]),Object.defineProperty(self,p,desc)})),callback&&"function"==typeof callback&&setTimeout((_=>callback.call(self)),0)}void 0===AmstramgramMediaPlayer.name&&(AmstramgramMediaPlayer.name="AmstramgramMediaPlayer"),"AUDIO"==media.tagName?new AmstramgramAudioPlayer(media,params,onPlayerInit,AmstramgramMediaPlayer):new AmstramgramVideoPlayer(media,params,onPlayerInit,AmstramgramMediaPlayer)}}export default AmstramgramMediaPlayer;
